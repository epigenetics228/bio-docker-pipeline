name: Bio Pipeline Pro with MultiQC

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sample: [Sample1, Sample2]
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t variant-caller .

      # ÐÐ°Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ MultiQC, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð² Ñ„Ð°Ð¹Ð»Ñ‹ .log
      - name: "Run Analysis with Logging"
        run: |
          docker run -v .:/app -w /app variant-caller sh -c "
          bwa index ref.fa 2> bwa_index.log && \
          fastp -i ${{ matrix.sample }}.fq -o clean.fq -h report.html 2> fastp.log && \
          bwa mem ref.fa clean.fq > align.sam 2> bwa_mem.log && \
          samtools sort align.sam -o sorted.bam 2> samtools.log && \
          bcftools mpileup -f ref.fa sorted.bam | bcftools call -mv -Ob -o variants.bcf 2> bcftools.log"

      # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð’Ð¡Ð• Ð»Ð¾Ð³Ð¸ Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ð°
      - name: Upload Logs for MultiQC
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.sample }}
          path: |
            *.log
            *.html
            *.bcf

  report:
    needs: analysis # Ð–Ð´ÐµÐ¼, Ð¿Ð¾ÐºÐ° Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ñ‹ Ð¸Ð· Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñ‹ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð°Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t variant-caller .

      # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð’Ð¡Ð•Ð¥ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ð¾Ð² Ð² Ð¾Ð´Ð½Ñƒ Ð¿Ð°Ð¿ÐºÑƒ
      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          path: all_logs/

      - name: "Generate MultiQC Report"
        run: |
          docker run -v .:/app -w /app variant-caller multiqc all_logs/ -o multiqc_report/
          
      - name: Deploy Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./multiqc_report    

      - name: Upload Final MultiQC Report
        uses: actions/upload-artifact@v4
        with:
          name: Final_MultiQC_Report
          path: multiqc_report/
          
      - name: Send Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            âœ… ÐÐ½Ð°Ð»Ð¸Ð· Ð±Ð¸Ð¾Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð½Ð²ÐµÐ¹ÐµÑ€Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!
            ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ MultiQC Ð³Ð¾Ñ‚Ð¾Ð² Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ….
            ðŸ§¬ Ð’ÑÐµ Ð¼ÑƒÑ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ð°Ð½Ð½Ð¾Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ SnpEff.    
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t variant-caller .

      - name: "Step 0: Indexing Reference"
        run: docker run -v .:/app -w /app variant-caller bwa index ref.fa
        
      - name: "Step 0.5: Trimming and QC (fastp)"
        run: |
          docker run -v .:/app -w /app variant-caller \
          fastp -i ${{ matrix.sample }}.fq \
                -o ${{ matrix.sample }}_clean.fq \
                -h ${{ matrix.sample }}_report.html \
                -j ${{ matrix.sample }}_report.json

      - name: "Step 1: Alignment (BWA)"
        run: |
          MODE=${{ github.event.inputs.alignment_mode || 'mem' }}
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐžÐ§Ð˜Ð©Ð•ÐÐÐ«Ð™ Ñ„Ð°Ð¹Ð» _clean.fq
          docker run -v .:/app -w /app variant-caller \
          bwa $MODE ref.fa ${{ matrix.sample }}_clean.fq > ${{ matrix.sample }}.sam
        
      - name: "Step 2: Sort and Index (Samtools)"
        run: |
          docker run -v .:/app -w /app variant-caller samtools sort ${{ matrix.sample }}.sam -o ${{ matrix.sample }}_sorted.bam
          docker run -v .:/app -w /app variant-caller samtools index ${{ matrix.sample }}_sorted.bam
          
      - name: "Step 3: Variant Calling (BCFtools)"
        run: |
          docker run -v .:/app -w /app variant-caller sh -c "bcftools mpileup -f ref.fa ${{ matrix.sample }}_sorted.bam | bcftools call -mv -Ob -o ${{ matrix.sample }}_variants.bcf"
          
      - name: "Step 3.5: Variant Annotation (SnpEff)"
        run: |
          docker run -v .:/app -w /app variant-caller sh -c "
          # 1. ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ BCF Ð² VCF Ð´Ð»Ñ SnpEff
          bcftools view variants.bcf > variants.vcf && \
          # 2. ÐÐ½Ð½Ð¾Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… GRCh38 Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°)
          # Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð·Ð°Ð´Ð°Ñ‡Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð¿Ð¾Ð´ Ñ‚Ð²Ð¾Ð¹ Ð³ÐµÐ½Ð¾Ð¼
          snpeff GRCh38.105 variants.vcf > variants_annotated.vcf 2> snpeff.log"    
          
      - name: "Step 4: Upload QC and Results"
        uses: actions/upload-artifact@v4
        with:
          name: full-results-${{ matrix.sample }}
          path: |
            ${{ matrix.sample }}_variants.bcf
            qc_reports/