name: Bio Pipeline CI
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      min_quality:
        description: 'Минимальное качество для фильтрации'
        required: true
        default: '20'
      alignment_mode:
        description: 'Режим BWA (например, mem)'
        required: true
        default: 'mem'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t variant-caller .

      - name: Run analysis test
        run: docker run variant-caller
        
      - name: "Step 0: Indexing Reference"
        run: docker run -v .:/app -w /app variant-caller bwa index ref.fa
        
      - name: "Step 1: Alignment (BWA)"
        run: docker run -v .:/app variant-caller bwa mem ref.fa reads.fq >alignment.sam
        
      - name: "Step 2: Sort and Index (Samtools)"
        run: |
          docker run -v .:/app variant-caller samtools sort alignment.sam -o alignment_sorted.bam
          docker run -v .:/app variant-caller samtools index alignment_sorted.bam
          
      - name: "Step 3: Variant Calling (BCFtools)"
        run: docker run -v .:/app -w /app variant-caller sh -c "bcftools mpileup -f ref.fa alignment_sorted.bam | bcftools call -mv -Ob -o variants.bcf"
          
      - name: "Step 4: Upload Result"
        uses: actions/upload-artifact@v4
        with:
          name: genetic-variants  # Имя архива, который вы скачаете
          path: variants.bcf      # Путь к нашему итоговому файлу